# BGE-M3 å¯¦ä½œé©—è­‰æŒ‡å—

> **ç›®çš„**: é©—è­‰ Week 2 Phase 2 (TDD Green) çš„ BGE-M3 Embedder å¯¦ä½œ
> **ç‹€æ…‹**: ç­‰å¾…æ‰‹å‹•é©—è­‰
> **é è¨ˆæ™‚é–“**: 2-3 åˆ†é˜ï¼ˆé¦–æ¬¡è¼‰å…¥æ¨¡å‹ï¼‰

---

## ğŸš€ å¿«é€Ÿé©—è­‰ï¼ˆæ¨è–¦ï¼‰

### æ–¹æ³• 1: é›™æ“ŠåŸ·è¡Œï¼ˆæœ€ç°¡å–®ï¼‰â­

```
ğŸ“ é›™æ“Šæ–‡ä»¶ï¼šC:\Users\User\.claude\Mem0Evomem\RUN_TEST.bat
```

**é æœŸçµæœ**ï¼š
```
============================================================
BGE-M3 é©—è­‰æ¸¬è©¦
============================================================

[Step 1] å°å…¥ä¾è³´...
[OK] ä¾è³´å°å…¥æˆåŠŸ

[Step 2] å°å…¥ BGEM3Embedding...
[OK] BGEM3Embedding å°å…¥æˆåŠŸ

[Step 3] å¯¦ä¾‹åŒ– BGEM3Embeddingï¼ˆè¼‰å…¥æ¨¡å‹ï¼‰...
[INFO] é€™å¯èƒ½éœ€è¦ 10-30 ç§’...
[OK] å¯¦ä¾‹åŒ–æˆåŠŸ

[Step 4] æ¸¬è©¦å–®æ–‡æœ¬åµŒå…¥...
[OK] è¿”å›å‘é‡ç¶­åº¦: 1024
[OK] ç¶­åº¦é©—è­‰é€šé

[Step 5] æ¸¬è©¦ç©ºæ–‡æœ¬éŒ¯èª¤...
[OK] éŒ¯èª¤è™•ç†æ­£ç¢º

[Step 6] æ¸¬è©¦æ‰¹æ¬¡åµŒå…¥...
[OK] è¿”å› 3 å€‹å‘é‡
[OK] æ‰¹æ¬¡åµŒå…¥é©—è­‰é€šé

[Step 7] æ¸¬è©¦æ¨¡å‹é…ç½®...
   - æ¨¡å‹åç¨±: BAAI/bge-m3
   - FP16: True
   - è¨­å‚™: cpu
   - æœ€å¤§é•·åº¦: 8192
[OK] é…ç½®é©—è­‰é€šé

============================================================
é©—è­‰çµæœ
============================================================

[SUCCESS] æ‰€æœ‰æ¸¬è©¦é€šéï¼

[INFO] ä¸‹ä¸€æ­¥ï¼šæäº¤ Green Phase
git commit -m 'feat(TDD-Green): å¯¦ç¾ BGE-M3 Embedder'
```

---

### æ–¹æ³• 2: å‘½ä»¤åˆ—åŸ·è¡Œ

```bash
cd C:\Users\User\.claude\Mem0Evomem
python simple_test.py
```

---

### æ–¹æ³• 3: å®Œæ•´é©—è­‰ï¼ˆ13 å€‹æ¸¬è©¦ï¼‰

```bash
cd C:\Users\User\.claude\Mem0Evomem
python scripts\verify_bge_m3_implementation.py
```

---

## ğŸ” é©—è­‰æ­¥é©Ÿèªªæ˜

### Step 1: å°å…¥ä¾è³´
- æª¢æŸ¥ `numpy` æ˜¯å¦å®‰è£
- æª¢æŸ¥ `FlagEmbedding` æ˜¯å¦å®‰è£
- å¦‚æœå¤±æ•—ï¼š`pip install numpy FlagEmbedding`

### Step 2: å°å…¥ BGEM3Embedding
- æª¢æŸ¥ `src/embeddings/bge_m3.py` æ˜¯å¦å­˜åœ¨
- æª¢æŸ¥ `BGEM3Embedding` é¡åˆ¥æ˜¯å¦æ­£ç¢ºå®šç¾©
- å¦‚æœå¤±æ•—ï¼šæª¢æŸ¥æ–‡ä»¶è·¯å¾‘å’Œèªæ³•éŒ¯èª¤

### Step 3: å¯¦ä¾‹åŒ–ï¼ˆè¼‰å…¥æ¨¡å‹ï¼‰
- é¦–æ¬¡åŸ·è¡Œæœƒä¸‹è¼‰ BAAI/bge-m3 æ¨¡å‹ï¼ˆç´„ 2GBï¼‰
- æ¨¡å‹æœƒç·©å­˜åˆ° `~/.cache/huggingface/`
- å¾ŒçºŒåŸ·è¡Œæœƒç›´æ¥è¼‰å…¥ç·©å­˜æ¨¡å‹ï¼ˆ5-10 ç§’ï¼‰
- å¦‚æœå¤±æ•—ï¼šæª¢æŸ¥ç¶²è·¯é€£æ¥æˆ–ç£ç¢Ÿç©ºé–“

### Step 4: æ¸¬è©¦å–®æ–‡æœ¬åµŒå…¥
- åµŒå…¥æ–‡æœ¬ "æ¸¬è©¦æ–‡æœ¬"
- é©—è­‰è¿”å› 1024 ç¶­å‘é‡
- é©—è­‰æ‰€æœ‰å…ƒç´ ç‚ºæµ®é»æ•¸
- å¦‚æœå¤±æ•—ï¼šæª¢æŸ¥ `embed()` æ–¹æ³•å¯¦ä½œ

### Step 5: æ¸¬è©¦ç©ºæ–‡æœ¬éŒ¯èª¤
- åµŒå…¥ç©ºæ–‡æœ¬ ""
- é©—è­‰æ‹‹å‡º `ValueError` ç•°å¸¸
- é©—è­‰ç•°å¸¸è¨Šæ¯åŒ…å« "ä¸èƒ½åµŒå…¥ç©ºæ–‡æœ¬"
- å¦‚æœå¤±æ•—ï¼šæª¢æŸ¥éŒ¯èª¤è™•ç†é‚è¼¯

### Step 6: æ¸¬è©¦æ‰¹æ¬¡åµŒå…¥
- åµŒå…¥ 3 å€‹æ–‡æœ¬
- é©—è­‰è¿”å› 3 å€‹å‘é‡
- é©—è­‰æ¯å€‹å‘é‡éƒ½æ˜¯ 1024 ç¶­
- å¦‚æœå¤±æ•—ï¼šæª¢æŸ¥ `batch_embed()` æ–¹æ³•å¯¦ä½œ

### Step 7: æ¸¬è©¦æ¨¡å‹é…ç½®
- é©—è­‰æ¨¡å‹åç¨±: "BAAI/bge-m3"
- é©—è­‰ FP16 ç²¾åº¦: True
- é©—è­‰è¨­å‚™: "cpu"
- é©—è­‰æœ€å¤§é•·åº¦: 8192
- å¦‚æœå¤±æ•—ï¼šæª¢æŸ¥ `__init__()` æ–¹æ³•åƒæ•¸

---

## âŒ å¸¸è¦‹éŒ¯èª¤è™•ç†

### éŒ¯èª¤ 1: ModuleNotFoundError: No module named 'FlagEmbedding'

**åŸå› **: ä¾è³´å¥—ä»¶æœªå®‰è£

**è§£æ±ºæ–¹æ¡ˆ**:
```bash
pip install FlagEmbedding
```

---

### éŒ¯èª¤ 2: FileNotFoundError: [Errno 2] No such file or directory: 'src/embeddings/bge_m3.py'

**åŸå› **: æ–‡ä»¶è·¯å¾‘éŒ¯èª¤æˆ–æ–‡ä»¶ä¸å­˜åœ¨

**è§£æ±ºæ–¹æ¡ˆ**:
```bash
# æª¢æŸ¥ç•¶å‰ç›®éŒ„
cd C:\Users\User\.claude\Mem0Evomem

# æª¢æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨
dir src\embeddings\bge_m3.py
```

---

### éŒ¯èª¤ 3: OSError: We couldn't connect to 'https://huggingface.co' to load this model

**åŸå› **: ç¶²è·¯é€£æ¥å•é¡Œæˆ– Hugging Face Hub ç„¡æ³•è¨ªå•

**è§£æ±ºæ–¹æ¡ˆ**:
```bash
# æ–¹æ¡ˆ 1: è¨­ç½®ä»£ç†ï¼ˆå¦‚æœéœ€è¦ï¼‰
set HTTP_PROXY=http://your-proxy:port
set HTTPS_PROXY=http://your-proxy:port

# æ–¹æ¡ˆ 2: æ‰‹å‹•ä¸‹è¼‰æ¨¡å‹
# ä¸‹è¼‰åˆ° ~/.cache/huggingface/hub/models--BAAI--bge-m3/
```

---

### éŒ¯èª¤ 4: torch.cuda.OutOfMemoryError

**åŸå› **: GPU è¨˜æ†¶é«”ä¸è¶³ï¼ˆä¸æ‡‰è©²ç™¼ç”Ÿï¼Œå› ç‚ºä½¿ç”¨ CPUï¼‰

**è§£æ±ºæ–¹æ¡ˆ**:
- æª¢æŸ¥ `device` åƒæ•¸æ˜¯å¦è¨­ç½®ç‚º "cpu"
- æª¢æŸ¥ `use_fp16` æ˜¯å¦ç‚º Trueï¼ˆæ¸›å°‘è¨˜æ†¶é«”ä½¿ç”¨ï¼‰

---

### éŒ¯èª¤ 5: AssertionError: Expected 1024 dimensions, got XXX

**åŸå› **: æ¨¡å‹è¿”å›çš„å‘é‡ç¶­åº¦ä¸æ­£ç¢º

**è§£æ±ºæ–¹æ¡ˆ**:
- æª¢æŸ¥æ¨¡å‹åç¨±æ˜¯å¦ç‚º "BAAI/bge-m3"
- æª¢æŸ¥æ˜¯å¦æ­£ç¢ºæå– `dense_vecs`
- æª¢æŸ¥è¿”å›å€¼è½‰æ›: `result['dense_vecs'][0].tolist()`

---

## âœ… é©—è­‰æˆåŠŸå¾Œ

### 1. æŸ¥çœ‹æ¸¬è©¦çµæœæ–‡ä»¶

```bash
type test_result.txt
```

### 2. æäº¤ Green Phase åˆ° Git

```bash
git add src/embeddings/bge_m3.py
git commit -m "feat(TDD-Green): å¯¦ç¾ BGE-M3 Embedder

- å¯¦ä½œ BGEM3Embedding é¡åˆ¥
- embed() æ–¹æ³•ï¼šå–®æ–‡æœ¬åµŒå…¥ â†’ 1024 ç¶­å‘é‡
- batch_embed() æ–¹æ³•ï¼šæ‰¹æ¬¡åµŒå…¥æ”¯æ´
- åŸºæœ¬éŒ¯èª¤è™•ç†ï¼šç©ºæ–‡æœ¬é©—è­‰
- é…ç½®å±¬æ€§ï¼šmodel_name, use_fp16, device, max_length

âœ… åŸºæœ¬æ¸¬è©¦é€šéï¼ˆ7/7ï¼‰
ğŸ“Š æ¸¬è©¦è¦†è“‹ç‡ï¼šå¾… Refactor éšæ®µé‡æ¸¬

ğŸ§ª Generated with Claude Code
Co-Authored-By: Claude <noreply@anthropic.com>"
```

### 3. æ¨é€åˆ° GitHub

```bash
git push origin integrate-psychohistory-v2
```

### 4. é–‹å§‹ Week 2 Phase 3: TDD Refactor

---

## ğŸ“Š æ¸¬è©¦çµ±è¨ˆ

| éšæ®µ | æ¸¬è©¦æ•¸é‡ | ç‹€æ…‹ |
|------|---------|------|
| **ç°¡å–®é©—è­‰** | 7 å€‹åŸºæœ¬æ¸¬è©¦ | â³ å¾…é©—è­‰ |
| **å®Œæ•´é©—è­‰** | 13 å€‹è©³ç´°æ¸¬è©¦ | â³ å¾…é©—è­‰ |
| **å–®å…ƒæ¸¬è©¦** | 19 å€‹ pytest æ¸¬è©¦ | âš ï¸ ç’°å¢ƒå•é¡Œï¼ˆä½¿ç”¨ç¨ç«‹é©—è­‰ï¼‰|

---

## ğŸ¯ ä¸‹ä¸€æ­¥è¡Œå‹•

### é¸é … A: é©—è­‰æˆåŠŸ âœ…
1. æäº¤ Green Phase commit
2. æ¨é€åˆ° GitHub
3. é–‹å§‹ Refactor Phaseï¼ˆå“è³ªå„ªåŒ–ï¼‰

### é¸é … B: é©—è­‰å¤±æ•— âŒ
1. è¤‡è£½éŒ¯èª¤è¨Šæ¯
2. å‘ŠçŸ¥ Claude
3. Claude è¨ºæ–·ä¸¦ä¿®å¾©

---

**âš¡ ç¾åœ¨è«‹åŸ·è¡Œé©—è­‰ï¼é›™æ“Š `RUN_TEST.bat` æˆ–é‹è¡Œå‘½ä»¤** âš¡

**é è¨ˆæ™‚é–“**: é¦–æ¬¡ 2-3 åˆ†é˜ï¼ˆä¸‹è¼‰æ¨¡å‹ï¼‰ï¼Œå¾ŒçºŒ 10-20 ç§’

---

*Last Updated: 2025-11-14*
*Version: 1.0*
*Maintainer: Mem0Evomem Team + zycaskevin*
